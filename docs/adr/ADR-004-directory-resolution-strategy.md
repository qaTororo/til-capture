# ADR-004: 保存先ディレクトリ解決戦略

> **ステータス**: `[Accepted]`
> **日付**: 2026-02-08
> **決定者**: プロジェクトオーナー
> **関連 Spec**: [05-config.md](../spec/05-config.md)

## 背景（Context）

til-capture v0.3 の保存先解決ロジックは 3 段階のフォールバック構造を持つ:

1. CWD 内の 3 パターン（`src/content/til/` > `content/til/` > `til/`）
2. `~/.config/til-capture/config.json` の `defaultTilDir`
3. フォールバック `~/til/`

このロジックは「ゼロコンフィグで動く」ことを優先した設計だが、ADR-002 で TIL の位置づけを「個人の知識整理・学びなおしのツール」に再定義したことで、設計思想との整合性を再検討する必要がある。

### 問題

- **フォールバック `~/til/` の妥当性**: 設定もせず、CWD にも `til/` がないユーザーに対して、`~/til/` にフォールバックする意味はあるか。TIL を残す意図がないユーザーに保存を提案するのは適切か
- **config.json の `defaultTilDir` = null の許容**: 設定ファイルが存在するのに保存先が未設定の状態を許容すべきか
- **意図的なセットアップ**: 知識整理は意図的な行為であり、保存先の決定も意図的であるべきではないか

## 決定ドライバー（Decision Drivers）

- **TIL の位置づけ**: 知識整理ツール（ADR-002）。意図的な行為であり、保存先も意図的であるべき
- **ユーザーリテラシー**: Claude Code ユーザーは CLI に慣れており、config.json の設定は許容範囲
- **初回体験**: インストール直後の体験が過度にハードルが高いと、ツールの評価機会を失う
- **設計原則 #2**: 安全なデフォルト — 意図しないディレクトリ作成を防ぐ
- **Plugin ライフサイクル**: 不要なら Plugin を削除するという自然な導線がある

## 検討した選択肢（Considered Options）

### 選択肢 A: 現行の寛容なフォールバック（v0.3 のまま）

CWD → config.json → `~/til/` の 3 段階。`~/til/` は低信頼としてユーザー確認を求めるが、フォールバック先は常に提供する。

| 観点 | 評価 |
|------|------|
| **利点** | ゼロコンフィグで動く。初回体験のハードルが低い |
| **欠点** | TIL を残す意図がないユーザーにも保存を提案してしまう。「知識整理ツール」の位置づけと矛盾する |
| **実装コスト** | なし（現状維持） |

### 選択肢 B: 厳格な意図要求（CWD または config 必須）

CWD に `til/` がある **または** config.json に `defaultTilDir` が設定されている場合のみ動作。どちらもない場合は毎セッションでアラートを表示し、TIL の保存は行わない。`~/til/` フォールバックは削除。

| 観点 | 評価 |
|------|------|
| **利点** | 「意図的なセットアップ」を要求することで、知識整理ツールとしての位置づけに合致。意図しない書き込みが完全に防げる |
| **欠点** | 初回体験のハードルが高い。「とりあえず試してみたい」ユーザーに不親切。アラートが毎セッション出るのは煩わしい可能性 |
| **実装コスト** | 中（フォールバック削除 + アラート実装 + 既存テスト修正） |

### 選択肢 C: 段階的な意図要求（フォールバックは fail-safe として残す）

CWD → config.json の 2 段階を主要ロジックとし、どちらもない場合はアラートを表示。`~/til/` は **fail-safe**（ユーザーが明示的に「そこで良い」と答えた場合のみ使用）として残すが、積極的に提案はしない。

config.json が存在する場合は `defaultTilDir` を必須とし、null/空の場合はアラートを表示する。

| 観点 | 評価 |
|------|------|
| **利点** | 意図的なセットアップを促しつつ、完全に保存不能にはならない。初回体験で「~/til/ に保存してよいか」と 1 回聞いて config.json を生成する導線も作れる |
| **欠点** | 選択肢 B ほど明確ではない。fail-safe の存在が「設定しなくても動く」という誤解を生む可能性 |
| **実装コスト** | 中（アラート実装 + config.json バリデーション強化） |

## 批判的分析

### 選択肢 B の妥当性検証

ユーザーの提案（選択肢 B に近い）を批判的に検証する:

**支持する論拠**:
1. ✅ **Claude Code ユーザーのリテラシー**: Claude Code を使う時点で、CLI に慣れた開発者。config.json の編集は問題ない
2. ✅ **Plugin ライフサイクル**: アラートが嫌なら Plugin を削除するだけ。この判断ができるリテラシーは想定ユーザーにある
3. ✅ **ADR-002 との整合性**: 知識整理は意図的な行為 → セットアップも意図的であるべき
4. ✅ **過保護の排除**: `~/til/` への自動フォールバックは「保存するはず」という過度な推定に基づいている

**反論**:
1. ⚠️ **初回体験**: インストール直後にアラートが出て何も動かないのは、第一印象が悪い → ただし、SessionStart hook でアラートと共に「設定方法」を案内すれば問題は軽減される
2. ⚠️ **アラート疲れ**: 毎セッション表示されるアラートがノイズになる → ただし、設定するか Plugin を削除するかの 2 択なので、長期間放置されることは少ない
3. ⚠️ **既存テストへの影響**: フォールバックテスト（stop-hook.bats #16, session-start-hook.bats #9）の修正が必要 → テスト修正は一回限りの作業

**総合評価**: 反論はいずれも軽微であり、選択肢 B の方針は妥当。

## 決定（Decision）

**採用: 選択肢 B（厳格な意図要求）**

理由:

1. **「意図的な知識整理」の一貫性**: ADR-002 で確立した TIL の位置づけと完全に整合する。保存先を決めるのはユーザーの意思であるべき
2. **過保護の排除**: `~/til/` への自動フォールバックは、ユーザーの意図を推定しすぎている。CWD に `til/` がない + 設定もない = TIL を残す意図がないと判断するのが自然
3. **Claude Code ユーザーのリテラシー**: config.json の設定は十分に許容範囲。不要なら Plugin を削除するという導線もある
4. **アラートの教育的価値**: 「設定してください」というアラートは、ユーザーに保存先を**意識的に選ばせる**きっかけになる

### 具体的な変更

| 項目 | 現行（v0.3） | 変更後（v1.0） |
|------|-------------|---------------|
| CWD `til/` 存在 | 高信頼で自動保存 | 変更なし |
| config.json `defaultTilDir` 設定 + 存在 | 高信頼で自動保存 | 変更なし |
| config.json `defaultTilDir` 設定 + 未存在 | 低信頼で確認 | 変更なし |
| config.json `defaultTilDir` = null/未設定 | フォールバック `~/til/` | **アラート表示。保存しない** |
| config.json 自体がない + CWD `til/` なし | フォールバック `~/til/` | **アラート表示。保存しない** |

### アラートメッセージ案

**SessionStart hook**:
```
TIL auto-capture: ⚠ No save destination configured.
Set defaultTilDir in ~/.config/til-capture/config.json or create a til/ directory in your project.
```

**Stop hook**（WebSearch/WebFetch 検知時）:
```
学びが検知されましたが、保存先が設定されていません。
~/.config/til-capture/config.json に defaultTilDir を設定するか、プロジェクト内に til/ ディレクトリを作成してください。
```

## 結果・影響（Consequences）

### ポジティブ

- 意図しないディレクトリ（`~/til/`）の作成が完全に防げる
- ユーザーが保存先を意識的に選ぶことで、TIL の管理がより組織的になる
- config.json の設定を促すことで、ユーザーの環境が標準化される

### ネガティブ

- フォールバック関連の既存テスト（2 件以上）を修正する必要がある
- 初回体験が「アラート → 設定 → 動作」の 3 ステップになる（現行は「フォールバック → 確認 → 保存」）
- 05-config.md の `[Implemented]` ステータスに影響する（実装変更が必要なため）

### リスクと緩和策

| リスク | 緩和策 |
|--------|--------|
| 初回体験が不親切と感じるユーザーがいる | アラートメッセージに設定手順を明記。SessionStart hook の出力で「1 行の config.json」を案内 |
| アラートが長期間無視される | 毎セッション表示することで自然に設定を促す。Plugin 削除という選択肢も提示 |
| v0.3 からの破壊的変更になる | v1.0 のリリースノートで変更を明記。移行ガイドを提供 |

## Spec ステータス変更

この ADR の Accepted に伴い、以下の Spec ステータスを変更する:

| Spec | 対象セクション | 変更前 | 変更後 |
|------|--------------|--------|--------|
| [05-config.md](../spec/05-config.md) | Step 3: フォールバック | `[Implemented]` | `[Accepted]`（v1.0 で実装変更が必要） |

> **注**: 05-config.md は v0.3 で `[Implemented]` だが、本 ADR の決定により v1.0 でフォールバックロジックの変更が必要になる。該当セクションのステータスを `[Accepted]`（再実装予定）に変更する。

## 未解決事項: 初回オンボーディング

### 問題

本 ADR の決定により、config.json の `defaultTilDir` 設定または CWD 内の `til/` ディレクトリが必須となる。しかし、Plugin をインストールした直後の最初のセッションでは:

1. config.json が存在しない
2. CWD に `til/` がない可能性が高い
3. → アラートが表示される
4. ユーザーが手動で config.json を作成する必要がある

この「鶏と卵」問題は、初回体験のハードルになりうる。

### 対応案

**SessionStart hook のアラートで Claude にセットアップ支援を依頼する**:

```
TIL auto-capture: ⚠ No save destination configured.
Please ask the user where to save TIL files, then create ~/.config/til-capture/config.json with:
{"defaultTilDir": "<user-specified-path>"}
If the user wants TIL files in the current project, they can create a til/ directory instead.
```

この方式であれば:
- Claude がユーザーに保存先を聞く（パターン B: 確認付き提案）
- ユーザーが回答した後、Claude が config.json を `Write` ツールで生成
- 次のセッションからは config.json が存在するため、アラートは出ない
- 既存の Hook→Claude→ユーザーの流れに自然に乗る

> **注**: この対応案の詳細設計は v1.0 の実装フェーズで確定する。本 ADR では方針のみを記録する。

## 関連リソース

- 関連 ADR: [ADR-001](./ADR-001-trust-based-confirmation-flow.md)（信頼度ベースの確認フロー）
- 関連 ADR: [ADR-002](./ADR-002-v1-feature-priority.md)（v1.0 機能の優先順位 — TIL の位置づけ再定義）
