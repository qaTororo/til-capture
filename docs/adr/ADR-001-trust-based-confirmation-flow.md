# ADR-001: 信頼度ベースの確認フロー

> **ステータス**: `[Accepted]`
> **日付**: 2026-02-08
> **決定者**: プロジェクトオーナー
> **関連 Spec**: [02-ux-patterns.md](../spec/02-ux-patterns.md), [05-config.md](../spec/05-config.md)

## 背景（Context）

til-capture は TIL ファイルをファイルシステムに書き込む。この副作用のある操作において、ユーザーに確認を求めるかどうかの方針を決める必要がある。

設計原則の「省力化ファースト」（手間を最小化したい）と「安全なデフォルト」（意図しない書き込みを防ぎたい）が直接対立しており、どちらを優先するかでユーザー体験が大きく変わる。

### 現状の制約

- セッション終了時の Stop hook は `decision: "block"` でしか Claude の処理を止められない（Hook 側で「確認」と「自動」を API レベルで区別する手段がない）
- Hook のメッセージ内容（`reason` フィールド）によって Claude の振る舞いを制御する設計
- ユーザーの日常利用では、既知のプロジェクト内で繰り返し TIL を記録するケースが多い

## 決定ドライバー（Decision Drivers）

- **設計原則 #1**: 省力化ファースト — 毎回の確認はユーザーの負担になる
- **設計原則 #2**: 安全なデフォルト — 意図しないディレクトリ作成やファイル書き込みを防ぐ
- **利用パターン**: 同じプロジェクトで繰り返し使うユーザーが主ターゲット
- **初回体験**: 初めて使うユーザーが「勝手にファイルが作られた」と感じるリスク
- **Hook の制約**: `reason` フィールドのメッセージ内容でしか動作を制御できない

## 検討した選択肢（Considered Options）

### 選択肢 A: 常にユーザー確認

すべての TIL 保存操作で、保存先をユーザーに確認してから実行する。

| 観点 | 評価 |
|------|------|
| **利点** | 最も安全。意図しない書き込みが発生しない。実装もシンプル |
| **欠点** | 省力化ファースト原則に反する。日常利用で毎回の確認がストレスになる |
| **実装コスト** | 低（Hook メッセージが 1 パターンで済む） |

### 選択肢 B: 常に自動保存

TIL 保存操作を常にユーザー確認なしで実行する。保存先が存在しなければ自動的に作成する。

| 観点 | 評価 |
|------|------|
| **利点** | 最も省力。ユーザーは何もしなくて良い |
| **欠点** | 安全なデフォルト原則に反する。`~/til/` が勝手に作られる。意図しないディレクトリにファイルが生成されるリスク |
| **実装コスト** | 低（Hook メッセージが 1 パターンで済む） |

### 選択肢 C: 信頼度ベースの切り替え（現行方式）

保存先の「信頼度」を判定し、高信頼なら自動保存、低信頼ならユーザー確認を求める。

| 観点 | 評価 |
|------|------|
| **利点** | 省力化と安全性の両立。既知の環境では省力、未知の環境では安全 |
| **欠点** | 実装が複雑（2 パターンのメッセージ、信頼度判定ロジック）。「高信頼」の定義が恣意的になりうる |
| **実装コスト** | 中（Hook メッセージ 2 パターン + 信頼度判定ロジック） |

**信頼度の定義（現行）**:

| 信頼度 | 条件 | 根拠 |
|--------|------|------|
| 高 | CWD 内に TIL ディレクトリが存在 | ユーザーが意図的に作成したと推定できる |
| 高 | config.json 設定 + ディレクトリ存在 | ユーザーが明示的に設定し、ディレクトリも存在する |
| 低 | config.json 設定 + ディレクトリ未存在 | 設定はあるがディレクトリが未作成（新規環境の可能性） |
| 低 | フォールバック `~/til/` | ユーザーが明示的に選択していない |

## 決定（Decision）

**採用: 選択肢 C（信頼度ベースの切り替え）**

理由:

1. **設計原則の優先順位に合致**: 省力化ファースト（#1）を基本としつつ、安全なデフォルト（#2）で制御する。信頼度はこの 2 つの原則の切り替えスイッチとして機能する
2. **「ディレクトリの存在」が信頼度の明確な指標**: ディレクトリが存在する = ユーザーが過去に意図的に作成した（または以前の保存で作成を承認した）という合理的な推定が成り立つ
3. **段階的に信頼が構築される UX**: 初回は確認を求め、ユーザーが承認して `mkdir -p` でディレクトリを作成すると、次回から自動保存になる。使い込むほど便利になる
4. **Hook の制約との相性**: `reason` フィールドのメッセージ内容で Claude の振る舞いを制御する設計と自然に噛み合う

## 結果・影響（Consequences）

### ポジティブ

- 日常利用のユーザー（プライマリペルソナ）は、2 回目以降の保存でストレスなく TIL を記録できる
- 初回利用のユーザーは、保存先を確認するステップで安心感を得られる
- 「使い込むほど便利になる」体験がユーザーの継続利用を促進する

### ネガティブ

- Hook メッセージが 2 パターン必要で、テストケースも増える（高信頼メッセージ用と低信頼メッセージ用）
- 信頼度の判定基準（「ディレクトリの存在」）がすべてのケースで適切とは限らない（例: 別の目的で `til/` ディレクトリが存在するケース）

### リスクと緩和策

| リスク | 緩和策 |
|--------|--------|
| `til/` が TIL 用でないのに高信頼と判定される | CWD パターンを `til/` だけでなく SSG の規約パス（`src/content/til/`, `content/til/`）と併用し、誤判定の確率を下げる |
| 信頼度の判定基準を将来変更したくなる | 信頼度判定ロジックを保存先解決ロジック内に集約し（05-config.md）、変更時の影響範囲を限定する |

## Spec ステータス変更

この ADR の Accepted に伴い、以下の Spec ステータスを変更する:

| Spec | 対象セクション | 変更前 | 変更後 |
|------|--------------|--------|--------|
| [02-ux-patterns.md](../spec/02-ux-patterns.md) | パターン B/C の信頼度分岐 | `[Draft]` | `[Accepted]` |

> **注**: 05-config.md は既に `[Implemented]` のため変更不要。02-ux-patterns.md は他の未決事項が残るため、全体ステータスの昇格は全 ADR 完了後に判断する。

## 関連リソース

- 関連 ADR: [ADR-004](./ADR-004-directory-resolution-strategy.md)（保存先ディレクトリ解決戦略）
- 設計原則: [00-vision.md §設計原則](../spec/00-vision.md#設計原則)
