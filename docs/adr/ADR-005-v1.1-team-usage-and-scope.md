# ADR-005: v1.1 チーム利用対応とスコープ判断

> **ステータス**: `[Accepted]`
> **日付**: 2026-02-08
> **決定者**: プロジェクトオーナー
> **関連 Spec**: [01-feature-inventory.md](../spec/01-feature-inventory.md), [05-config.md](../spec/05-config.md), [06-future-features.md](../spec/06-future-features.md)

## 背景（Context）

v1.0 リリース後、プロダクトの次の方向性を検討するにあたり「アイデア箱」として以下のテーマが挙がった:

1. **重複保存の許可**: 現在計画中の F-103（重複チェック）は本当に必要か
2. **スクラムチームでの活用**: 共有 TIL リポジトリを作り、レトロで AI にまとめ読みさせるユースケース
3. **コンテキスト汚染**: Stop hook 経由の TIL 生成が Claude 本体のコンテキストを消費する問題
4. **タグ機能の要否**: ripgrep で全文検索できるなら、タグは不要ではないか

これらのテーマに対して v1.1 のスコープを決定する必要がある。

### v1.0 の位置づけとの関係

ADR-002 で TIL を「個人の知識整理・学びなおしのツール」と位置づけた。v1.1 ではこの位置づけを維持しつつ、チーム利用という新しいユースケースの仮説検証を行う。

### 制約

- 商用プロダクトではないため、過度な設計投資は避ける
- チームでの利用は仮説段階であり、検証前に大きな投資をすべきではない
- コンテキスト汚染はユーザー体験に直接影響するが、アーキテクチャ変更を伴う

## 決定ドライバー（Decision Drivers）

- **仮説検証コスト**: チーム利用の仮説を最小コストで検証できるか
- **ユーザー体験**: コンテキスト汚染は利用継続のブロッカーになりうる
- **哲学的判断**: 重複は「問題」なのか「シグナル」なのか
- **実装の独立性**: 各変更が他の変更に依存せず独立して実施できるか
- **後方互換**: 既存の個人利用ユーザーへの影響を最小化する

## 決定 1: F-103（重複チェック）の永久除外

### 検討した選択肢

#### 選択肢 A: v1.1 で重複チェックを実装

06-future-features.md の計画通り、Claude に類似判定を委ねる方式で実装する。

| 観点 | 評価 |
|------|------|
| **利点** | 同一トピックの TIL が増殖しない。保存先ディレクトリがクリーンに保たれる |
| **欠点** | 実装複雑度が高い。直近 30 日分の TIL を走査する token コストがかかる |
| **実装コスト** | 高 |

#### 選択肢 B: 重複を永久に許可する（チェック機能を作らない）

重複は問題ではないという判断を下し、F-103 をスコープから完全に除外する。

| 観点 | 評価 |
|------|------|
| **利点** | 実装コストゼロ。token コスト削減。知識定着の観点で合理的 |
| **欠点** | 長期的に TIL ディレクトリが膨張する可能性 |
| **実装コスト** | なし |

#### 選択肢 C: 設定で重複チェックの ON/OFF を切り替え

config.json に `allowDuplicates` フラグを追加し、ユーザーに選択させる。

| 観点 | 評価 |
|------|------|
| **利点** | 両方のニーズに対応できる |
| **欠点** | F-103 自体の実装コストは変わらない。設定が増えて複雑化する |
| **実装コスト** | 高 |

### 決定

**採用: 選択肢 B（重複を永久に許可）**

理由:

1. **知識定着のシグナル**: 同じトピックが繰り返し出現することは、知識が定着していないサイン。記録する価値がある
2. **AI 消費モデルとの整合**: TIL を AI にまとめ読みさせるスタイルでは、重複は問題にならない。AI は頻出トピックを重み付けして扱う可能性があり、それは許容範囲内
3. **token コスト削減**: 重複チェックのために既存 TIL を走査する token コストが不要になる
4. **商用でないプロダクト**: 精緻な重複検出に投資する合理性がない

> **注**: これは「永久に不要」という哲学的判断である。チーム利用で膨張が問題になった場合も、重複チェック（プラグイン側の機能）ではなく、AI によるまとめ読みや定期的なキュレーション（ユーザー側の運用）で対処する方針。

## 決定 2: v1.1 の優先テーマ — チーム利用対応（仮説検証）

### 検討した選択肢

#### 選択肢 A: チーム利用対応を優先

author フィールドを config.json に追加し、frontmatter に記録する。最小コストでチーム利用の仮説を検証可能にする。

| 観点 | 評価 |
|------|------|
| **利点** | 実装コストが極めて低い（config 1 フィールド + frontmatter 1 行）。チーム利用の仮説検証が可能になる |
| **欠点** | コンテキスト汚染問題が先送りされる。チーム展開時にブロッカーになりうる |
| **実装コスト** | 低 |

#### 選択肢 B: UX 改善（コンテキスト汚染対策）を優先

Stop hook 経由の TIL 生成を sub-agent 化し、本体のコンテキストを保護する。

| 観点 | 評価 |
|------|------|
| **利点** | 個人利用・チーム利用の両方で体験が向上する。既存ユーザーへの恩恵が大きい |
| **欠点** | アーキテクチャ変更を伴い、実装コストが高い |
| **実装コスト** | 中〜高 |

#### 選択肢 C: 両方同時に実施

author 追加と sub-agent 化を同じバージョンで実装する。

| 観点 | 評価 |
|------|------|
| **利点** | チーム利用の仮説検証と UX 改善を同時に達成できる |
| **欠点** | スコープが大きくなり、リリースリスクが高い |
| **実装コスト** | 中〜高 |

### 決定

**採用: 選択肢 A（チーム利用対応を優先）、UX 改善は v1.2 で対応**

理由:

1. **仮説検証の投資対効果**: スクラムチームで共有 TIL リポジトリを作り、レトロで活用するユースケースはまだ仮説段階。仮説の検証に大きな投資をするのは非合理的であり、最小コスト（author フィールド追加のみ）で検証可能にすべき
2. **独立性**: author 追加は既存アーキテクチャへの影響がなく、UX 改善とは完全に独立して実施できる。先に入れても後の UX 改善を阻害しない
3. **段階的検証**: author を入れてチームで実際に使ってみることで、コンテキスト汚染がどの程度問題になるかの実データが得られる。UX 改善の優先度判断にフィードバックできる

### 仮説の定義

| 項目 | 内容 |
|------|------|
| **仮説** | スクラムチームで共有 TIL リポジトリを運用し、レトロで AI にまとめ読みさせることで、チームの学びの共有が促進される |
| **検証方法** | author フィールドを使って実際にチームで運用してみる |
| **成功基準** | 未定義（実際の運用で判断） |
| **失敗時** | author フィールドは個人利用でも有用なメタデータとして残る。投資の損失は最小限 |

## 決定 3: author フィールドの設計

### 検討した選択肢

#### 選択肢 A: config.json トップレベルに配置

```json
{"defaultTilDir": "/path/to/til", "author": "username"}
```

| 観点 | 評価 |
|------|------|
| **利点** | シンプル。F-101（テンプレートカスタマイズ）全体を実装する必要がない。author はテンプレートの一部ではなくユーザーのアイデンティティ |
| **欠点** | 将来 F-101 を実装した際に、frontmatter カスタムフィールドと author の住み分けが必要 |
| **実装コスト** | 低 |

#### 選択肢 B: F-101 の template.frontmatter 内に配置

```json
{"defaultTilDir": "/path/to/til", "template": {"frontmatter": {"author": "username"}}}
```

| 観点 | 評価 |
|------|------|
| **利点** | F-101 の設計に沿った配置。将来の拡張と整合的 |
| **欠点** | F-101 の template マージロジック全体を実装する必要がある。仮説検証のためだけにオーバーエンジニアリング |
| **実装コスト** | 中〜高 |

### 決定

**採用: 選択肢 A（トップレベルに配置）**

理由:

1. **author はアイデンティティ**: テンプレートのカスタムフィールドではなく、「このプラグインを使っているのは誰か」というアイデンティティ情報。トップレベルが意味的に正しい
2. **最小実装**: 仮説検証フェーズでは最小の実装が正解。F-101 のマージロジックを先行実装する根拠がない
3. **将来の整合性**: F-101 を将来実装する際、author はトップレベルに残し、template.frontmatter にはカスタムフィールドのみ入れる整理で矛盾しない

## 決定 4: タグ機能の維持

タグ機能（F-102）は v1.0 で実装済みであり、v1.1 で変更しない。

**理由**: 削除コスト > 維持コスト。ripgrep での全文検索とタグによるメタデータ分類は別の価値を提供する。タグは frontmatter の構造化メタデータとして AI や他ツールから読みやすい利点がある。

## 結果・影響（Consequences）

### ポジティブ

- チーム利用の仮説を最小コストで検証可能になった
- F-103 除外により、token コスト削減と実装の簡素化を実現
- author 未設定時は v1.0 と完全に同一動作し、後方互換を維持

### ネガティブ

- コンテキスト汚染問題が v1.2 まで先送りされた。チーム利用の本格展開時にブロッカーになるリスクがある
- チーム利用の仮説が未検証のまま author フィールドをリリースしている（ただし投資は最小限）

### リスクと緩和策

| リスク | 影響度 | 緩和策 |
|--------|--------|--------|
| コンテキスト汚染がチーム展開のブロッカーになる | 中 | v1.2 で sub-agent 化による UX 改善を計画済み。v1.1 の運用でブロッカーの深刻度を実データで把握する |
| スクラムレトロの仮説が成立しない | 低 | author は個人利用でも有用なメタデータ。投資損失は config 1 フィールド + frontmatter 1 行のみ |
| TIL ディレクトリがチーム利用で膨張する | 低 | 重複は問題ではないという哲学的判断（決定 1）に基づき、AI まとめ読みや定期キュレーションで対処 |
| `/til-summary` のようなまとめスキルがないとレトロでの活用が手動になる | 低 | 現時点では手動（Claude に直接依頼）で対応。需要が確認できたら将来バージョンで検討 |

## 次回以降の作業計画

### 次回セッション: ドキュメント更新

v1.0 リリース完了と本 ADR の内容を反映したドキュメント整備を行う。Living Spec、アーキテクチャドキュメント等の更新。

### 次々回セッション: v1.2 UX 改善の実務

以下を議論の出発点とする:

1. **コンテキスト汚染対策**: TIL 記録の sub-agent 化（バックグラウンド実行）を検討。Stop hook が `decision: "block"` で本体 Claude に TIL 生成を委ねている現状を、sub-agent に委譲する方向
2. **v1.1 運用からの学び**: author フィールドを使ったチーム利用の実体験から得られたフィードバックを反映
3. **アイデア箱の残課題**: 記録内容のカスタマイズ（コードベース固有の学び vs 一般的な学び）

## Spec ステータス変更

この ADR の Accepted に伴い、以下の Spec ステータスを変更する:

| Spec | 対象セクション | 変更前 | 変更後 |
|------|--------------|--------|--------|
| [01-feature-inventory.md](../spec/01-feature-inventory.md) | F-103 | `[Draft]` | `[Out of Scope]` |
| [01-feature-inventory.md](../spec/01-feature-inventory.md) | F-111（新規） | — | `[Implemented]` |
| [05-config.md](../spec/05-config.md) | author フィールド | — | `[Implemented]` |
| [06-future-features.md](../spec/06-future-features.md) | F-103 | `[Draft]` | `[Out of Scope]` |

## 関連リソース

- 関連 ADR: [ADR-002](./ADR-002-v1-feature-priority.md)（v1.0 機能の優先順位 — TIL の位置づけ定義）
- 関連 ADR: [ADR-003](./ADR-003-new-hook-event-strategy.md)（新規 Hook 慎重待機 — sub-agent 化検討時の制約）
- 入力: アイデア箱（重複保存、スクラムチーム活用、コンテキスト汚染、タグ要否の4テーマ）
