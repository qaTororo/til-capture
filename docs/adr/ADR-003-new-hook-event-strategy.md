# ADR-003: 新規 Hook イベント活用方針

> **ステータス**: `[Accepted]`
> **日付**: 2026-02-08
> **決定者**: プロジェクトオーナー
> **関連 Spec**: [06-future-features.md](../spec/06-future-features.md)

## 背景（Context）

til-capture v0.3 は Claude Code の `Stop` と `SessionStart` の 2 つの Hook イベントのみを使用している。Claude Code には他にも `PostToolUse`、`UserPromptSubmit` 等の Hook イベントが存在し、これらを活用すれば検知精度の向上やリアルタイムのトピック蓄積が可能になる。

06-future-features.md では以下の 3 機能が新規 Hook イベントを活用する候補として挙がっている:

| 機能 | 使用する Hook | 用途 |
|------|-------------|------|
| F-104 | PostToolUse (Write) | TIL 書き込み後のメタデータ付与 |
| F-105 | UserPromptSubmit | キーワード検知で /til 提案 |
| F-106 | PostToolUse (WebSearch) | リアルタイム調査トピック蓄積 |

しかし、これらの Hook イベントが Claude Code Plugin で安定的に利用可能かどうかは、Plugin プラットフォームの仕様に依存する。

## 決定ドライバー（Decision Drivers）

- **プラットフォーム安定性**: Claude Code Plugin の Hook 仕様はまだ進化途上であり、API が変更される可能性がある
- **メンテナンスコスト**: 不安定な API に依存するコードは、プラットフォーム更新のたびに修正が必要になる
- **v1.0 のスコープ**: ADR-002 で v1.0 のスコープを F-102 + F-107 に絞っており、新規 Hook 活用機能は含まれない
- **現行アーキテクチャの十分性**: Stop + SessionStart の 2 イベントで、基本的な自動検知と手動記録の UX は成立している
- **将来の拡張性**: 新規 Hook イベントを「使えるようになったら使う」設計にしておきたい

## 検討した選択肢（Considered Options）

### 選択肢 A: 慎重待機

v1.0 では現行の Stop + SessionStart のみ使用。新規 Hook イベントは仕様が安定した時点で評価・実装する。

| 観点 | 評価 |
|------|------|
| **利点** | メンテナンスコストが低い。プラットフォーム変更の影響を受けない。v1.0 のスコープに集中できる |
| **欠点** | 検知精度の向上が遅れる。リアルタイムトピック蓄積の実現が先送り |
| **実装コスト** | なし（現状維持） |

### 選択肢 B: 選択的採用

利用可能になった Hook イベントから、価値の高いものを選んで v1.0 に部分的に取り込む。

| 観点 | 評価 |
|------|------|
| **利点** | 早期に検知精度を向上できる。ユーザー体験の改善が早い |
| **欠点** | 不安定な API に依存するリスク。v1.0 のスコープが膨らむ。テスト・検証の負荷が増える |
| **実装コスト** | 中（選択した Hook の数に応じて） |

### 選択肢 C: 積極採用

利用可能な新規 Hook イベントをすべて実装し、検知精度を最大化する。

| 観点 | 評価 |
|------|------|
| **利点** | 最も高い検知精度。差別化された UX を早期に実現 |
| **欠点** | メンテナンスコストが最大。API 変更時の修正範囲が広い。テスト負荷が高い |
| **実装コスト** | 高（3 機能分の Hook 実装 + テスト） |

## 決定（Decision）

**採用: 選択肢 A（慎重待機）**

理由:

1. **v1.0 のスコープとの整合**: ADR-002 で v1.0 を F-102 + F-107 に絞った。新規 Hook 活用はスコープ外であり、追加する理由がない
2. **現行アーキテクチャで十分**: Stop hook でのトランスクリプト走査（WebSearch/WebFetch 検知）は、v0.3 の全テスト（41 件）で検証済みの安定した手法。現時点で検知精度の問題報告はない
3. **プラットフォームリスクの回避**: Claude Code Plugin の Hook API が安定するまで、不安定な API への依存を避ける。API 変更時の修正コストはゼロ
4. **「使えるようになったら使う」設計の維持**: 06-future-features.md に候補として記録しておくことで、仕様が安定した時点で迅速に評価・実装できる準備はできている

### 新規 Hook イベント採用の判断基準（将来向け）

以下の条件が満たされた時点で、新規 Hook イベントの採用を再評価する:

| 条件 | 確認方法 |
|------|---------|
| Claude Code Plugin の Hook API が安定版としてリリースされた | Claude Code のリリースノートを確認 |
| til-capture の基本機能（v1.0）が安定稼働している | ユーザーからのフィードバック |
| 新規 Hook イベントの仕様が文書化されている | Claude Code の公式ドキュメント |

## 結果・影響（Consequences）

### ポジティブ

- v1.0 のスコープが明確に維持される
- メンテナンスコストが最小限に抑えられる
- プラットフォーム更新の影響を受けないため、リリースが安定する

### ネガティブ

- F-104, F-105, F-106 の実装が v1.1+ に延期される
- リアルタイムトピック蓄積（F-106）による検知精度向上が遅れる

### リスクと緩和策

| リスク | 緩和策 |
|--------|--------|
| 競合ツールが新規 Hook を先に活用する | til-capture の差別化は Hook の活用数ではなく、「学びなおし」の UX にある（ADR-002 参照） |
| Hook 仕様が安定した後の実装が遅れる | 06-future-features.md に設計ドラフトを維持しておくことで、実装開始時の立ち上がりを早くする |

## Spec ステータス変更

この ADR の Accepted に伴い、以下の Spec ステータスを変更する:

| Spec | 対象セクション | 変更前 | 変更後 |
|------|--------------|--------|--------|
| [06-future-features.md](../spec/06-future-features.md) | F-104, F-105, F-106 | `[Draft]` | `[Draft]`（変更なし。v1.1+ として維持） |
| [06-future-features.md](../spec/06-future-features.md) | 新規 Hook イベント活用候補 テーブル | `[Draft]` | `[Accepted]`（慎重待機方針の確定） |

## 関連リソース

- 関連 ADR: [ADR-002](./ADR-002-v1-feature-priority.md)（v1.0 機能の優先順位）
- Claude Code Hook 仕様: https://docs.anthropic.com/en/docs/claude-code/hooks
