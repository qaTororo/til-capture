# 機能仕様: 手動キャプチャ

> **ステータス**: `[Implemented]` (v0.3.0、v1.0.0 / v1.1.0 で更新)
> **最終更新**: 2026-02-09

## 概要

| 項目 | 値 |
|------|-----|
| **機能 ID** | F-003 |
| **種別** | Skill |
| **実装** | `skills/til/SKILL.md` |
| **テスト** | なし（Skill は Claude の解釈に依存するため、E2E テストの対象外） |
| **UX パターン** | D（コマンド起点の対話型実行） |

## ユーザーストーリー

> 開発者として、セッション中の任意のタイミングで学びを TIL として記録したい。自動キャプチャを待たず、重要な学びをその場で残せるようにしたい。

## トリガー条件

以下のいずれかでスキルが起動する:

| トリガー | 例 |
|---------|-----|
| コマンド | `/til-capture:til` |
| 自然言語（英語） | "record a TIL", "capture what I learned", "save today's learning" |
| 自然言語（日本語） | "TILを記録", "学びを保存" |
| Stop hook からの提案 | パターン B/C 経由で Claude が /til を実行 |

### 引数

- `$ARGUMENTS`: オプション。カテゴリやトピックのヒントとして使用
- 未指定時: 会話コンテキストから Claude が自動判定

## 振る舞い仕様

### 処理フロー

```mermaid
flowchart TD
    A[スキル起動] --> B[1. 学びの特定]
    B --> C[2. 保存先の解決]
    C --> D{信頼度?}
    D -->|高信頼| E[3. ファイル生成]
    D -->|低信頼| F[ユーザーに確認]
    F -->|承認| G[mkdir -p + ファイル生成]
    F -->|拒否| H[スキップ]
    E --> I[4. 結果報告]
    G --> I
```

### Step 1: 学びの特定

Claude が会話コンテキストから以下を抽出する:

| 抽出対象 | 説明 | 例 |
|---------|------|-----|
| 技術的な学び | ツールの使い方、API の仕様など | "jq の `-r` フラグで raw output" |
| 調査で分かった事実 | 仕様、ベストプラクティスなど | "bash の `set -C` で noclobber" |
| 失敗から得た教訓 | デバッグのコツ、避けるべきパターン | "TOCTOU 問題を避けるには..." |

### Step 2: 保存先の解決

保存先の解決ロジックは [05-config.md](./05-config.md) で定義。ここでは Skill 実装固有の振る舞いを記述する。

| # | 条件 | 動作 | UX パターン |
|---|------|------|-----------|
| 1 | CWD 内に TIL ディレクトリ存在 | そのまま保存 | D（確認なし） |
| 2 | config.json + ディレクトリ存在 | そのまま保存 | D（確認なし） |
| 3 | config.json + ディレクトリ未存在 | ユーザー確認 → `mkdir -p` | D（確認あり） |
| 4 | 保存先未設定 | 設定方法を案内して終了 | D（アラート） |

**制約事項**:
- Glob での無制限検索は行わない（SKILL.md で明記）
- 低信頼パスは必ずユーザー確認を行う
- `mkdir -p` はユーザー承認後のみ実行可
- 保存先未設定時は保存を行わず、config.json の設定方法を案内（[ADR-004](../adr/ADR-004-directory-resolution-strategy.md)）

### Step 3: ファイル生成

#### ファイル名規則

```
YYYY-MM-DD-<slug>.md
```

- `YYYY-MM-DD`: `date +%Y-%m-%d` で取得した生成日
- `<slug>`: タイトルから生成した英語 kebab-case

#### テンプレート

```markdown
---
title: "学びのタイトル"
date: YYYY-MM-DD
author: "username"
tags: [tag1, tag2]
draft: true
---

## 概要
（1-2文の要約）

## 詳細
（学びの詳細な説明）

## コード例
（該当する場合のみ）

## 参考
（関連リンクや背景情報）
```

#### frontmatter フィールド

| フィールド | 型 | 必須 | 生成方法 |
|-----------|-----|------|---------|
| `title` | string | Yes | Claude が学びの内容から生成 |
| `date` | string (YYYY-MM-DD) | Yes | `date +%Y-%m-%d` |
| `author` | string | No | config.json の `author` 値（未設定時は行自体を省略） |
| `tags` | string[] | Yes | Claude が内容から推定（1個以上）。既存タグを優先使用（F-102） |
| `draft` | boolean | Yes | 常に `true` |

#### セクション

| セクション | 必須 | 説明 |
|-----------|------|------|
| 概要 | Yes | 1-2 文の要約 |
| 詳細 | Yes | 学びの詳細な説明 |
| コード例 | No | 該当する場合のみ |
| 参考 | No | 関連リンクや背景情報 |

### Step 4: 結果報告

保存完了後、以下を報告する:

- 保存先ファイルパス
- 内容のサマリー（タイトル、タグ）

## 許可ツール

| ツール | 用途 | 制限 |
|--------|------|------|
| `Read` | config.json 読み取り、既存 TIL 参照 | — |
| `Write` | TIL ファイル生成 | — |
| `Glob` | 保存先ディレクトリの探索 | **無制限検索は禁止** |
| `Grep` | 既存 TIL の内容検索 | — |
| `Bash(date:*)` | 日付取得 | `date` コマンドのみ |
| `Bash(mkdir:*)` | ディレクトリ作成 | `mkdir` コマンドのみ |

## セキュリティ要件

- 保存先の検証は [05-config.md](./05-config.md) のロジックに従う
- Glob の無制限検索禁止は SKILL.md 内で明記されているが、Claude の解釈に依存する
- `mkdir -p` は低信頼パス時にユーザー確認後のみ実行

## 変更履歴

### v1.0.0

- **F-102**: タグ自動補完を実装 — 既存 TIL からタグを抽出し、新規 TIL 作成時に既存タグを優先使用
- **フォールバック削除**: `~/til/` フォールバックを削除、保存先未設定時は設定方法を案内して終了（[ADR-004](../adr/ADR-004-directory-resolution-strategy.md)）
- **F-103**: 重複チェックをスコープ外に変更（[ADR-005](../adr/ADR-005-v1.1-team-usage-and-scope.md)）

### v1.1.0

- **F-111**: config.json の `author` フィールドを読み取り、frontmatter に `author` を条件付きで追加
- config.json を保存先の有無に関わらず常に読み取るよう変更（author 取得のため）

### 将来バージョンでの検討

- **F-101: テンプレートカスタマイズ** — frontmatter/セクション構成の設定化
- **F-108: Draft → Publish ワークフロー** — `draft: true` → `draft: false` の管理
